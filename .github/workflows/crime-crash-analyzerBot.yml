# name: Notify AI CI Bot

# on:
#   workflow_run:
#     workflows: ["CI"]
#     types: [completed]

# jobs:
#   analyze-failure:
#     if: ${{ github.event.workflow_run.conclusion == 'failure' }}
#     runs-on: ubuntu-latest

#     steps:
#       - name: Download CI logs
#         env:
#           GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#         run: |
#           mkdir logs
#           gh run view ${{ github.event.workflow_run.id }} \
#             --repo ${{ github.repository }} \
#             --dir logs
#           cat logs/** > ci_logs.txt

#       - name: Send logs to CI Agent
#         env:
#           CI_AGENT: ${{ secrets.CI_AGENT }}
#         run: |
#           curl -X POST "$CI_AGENT/analyze" \
#           -H "Content-Type: application/json" \
#           -d '{
#             "repo": "'"${{ github.repository }}"'",
#             "run_id": "'"${{ github.event.workflow_run.id }}"'",
#             "logs": "'"$(cat ci_logs.txt | sed 's/"/\\"/g')"'"
#           }'



name: Notify AI CI Bot

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  analyze-failure:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      - name: Debug workflow_run payload
        run: |
          echo "Workflow name: ${{ github.event.workflow_run.name }}"
          echo "Workflow conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Workflow status: ${{ github.event.workflow_run.status }}"
          echo "Run ID: ${{ github.event.workflow_run.id }}"

      - name: Download CI artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir logs
          gh run download ${{ github.event.workflow_run.id }} \
            --repo ${{ github.repository }} \
            --dir logs

          cat logs/** > ci_logs.txt

      - name: Send logs to CI Agent
        env:
          CI_AGENT: ${{ secrets.CI_AGENT }}
        run: |
          curl -X POST "$CI_AGENT/analyze" \
          -H "Content-Type: application/json" \
          -d @- <<EOF
          {
            "repo": "${{ github.repository }}",
            "run_id": "${{ github.event.workflow_run.id }}",
            "logs": "$(sed 's/"/\\"/g' ci_logs.txt)"
          }
          EOF
