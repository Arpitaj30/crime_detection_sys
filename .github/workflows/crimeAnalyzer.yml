name: Notify AI CI Bot

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  analyze-failure:
    name: Analyze CI Failure with AI Bot
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # 1. Checkout the failed repository (crime_detection_sys)
      # -------------------------------------------------
      - name: Checkout target repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2. Checkout AI CI Bot repository
      # -------------------------------------------------
      - name: Checkout Ci-Smart-Bot repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/Ci-Smart-Bot
          path: bot-agent
          token: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------------------------------
      # 3. Download CI logs from failed workflow
      # -------------------------------------------------
      - name: Download CI logs artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p logs

          gh run download ${{ github.event.workflow_run.id }} \
            --repo ${{ github.repository }} \
            --dir logs

          # Merge all .log files into one
          find logs -type f -name "*.log" -exec cat {} + > logs/ci_logs.txt || true

      # -------------------------------------------------
      # 4. Setup Python
      # -------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # -------------------------------------------------
      # 5. Install AI Bot dependencies
      # -------------------------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r bot-agent/requirements.txt

      # -------------------------------------------------
      # 6. Send logs to AI CI Bot
      # -------------------------------------------------
      - name: Send logs to AI CI Bot
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          LLM_PROVIDER: groq
        run: |
          cd bot-agent
          python - << 'EOF'
          import os
          import sys

          sys.path.insert(0, ".")  # repo root
          from bot.error_analyzer import analyze_error

          logs_path = "../logs/ci_logs.txt"

          if not os.path.exists(logs_path):
            print("No CI logs found")
            sys.exit(1)

          with open(logs_path, "r") as f:
            logs_content = f.read()

          print("ðŸš¨ Crime Detection System CI Failed")
          print(f"Repository: ${{ github.repository }}")
          print(f"Run ID: ${{ github.event.workflow_run.id }}")
          print(f"Logs Size: {len(logs_content)} bytes")
          print("-" * 50)

          # Call bot function to analyze logs
          suggestion = analyze_error(logs_content)
          print("ðŸ’¡ Suggested Fix:")
          print(suggestion)
          EOF

      - name: Comment PR with bot suggestion
        if: ${{ github.event.workflow_run.pull_requests }}
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          LLM_PROVIDER: groq
        run: |
          cd bot-agent
          python - << 'EOF'
          import sys
          sys.path.insert(0, ".")

          from bot.error_analyzer import analyze_error

          with open("../logs/ci_logs.txt") as f:
          logs = f.read()

          suggestion = analyze_error(logs)
          print(suggestion)
          EOF