name: Notify AI CI Bot

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  analyze-failure:
    name: Analyze CI Failure with AI Bot
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      #  Checkout the failed repository (crime_detection_sys)
      # -------------------------------------------------
      - name: Checkout target repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      #  Download CI logs from failed workflow
      # -------------------------------------------------
      - name: Download CI logs artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p logs

          gh run download ${{ github.event.workflow_run.id }} \
            --repo ${{ github.repository }} \
            --dir logs

          # Merge all .log files into one
          find logs -type f -name "*.log" -exec cat {} + > logs/ci_logs.txt || true

      # -------------------------------------------------
      #  Setup Python
      # -------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # -------------------------------------------------
      # Send logs to AI CI Bot
      # -------------------------------------------------
      - name: Send logs to AI CI Bot (via ngrok)
        env:
          CI_AGENT: ${{ secrets.CI_AGENT }}
        run: |
          echo "Sending logs to AI Bot server..."

          curl -X POST "$CI_AGENT_URL/analyze" \
          -H "Content-Type: application/json" \
          -d @- << EOF
          {
            "repository": "${{ github.repository }}",
            "run_id": "${{ github.event.workflow_run.id }}",
            "logs": "$(sed 's/"/\\"/g' logs/ci_logs.txt)"
          }
          EOF

      - name: Get bot suggestion from AI server
        id: bot
        env:
          CI_AGENT: ${{ secrets.CI_AGENT }}
        run: |
          RESPONSE=$(curl -s -X POST "$CI_AGENT_URL/analyze" \
            -H "Content-Type: application/json" \
            -d @- << EOF
          {
            "repo": "${{ github.repository }}",
            "run_id": "${{ github.event.workflow_run.id }}",
            "installation_id": "${{ secrets.GH_APP_INSTALLATION_ID }}",
            "logs": "$(sed 's/"/\\"/g' logs/ci_logs.txt)"
          }
          EOF
          )
          echo "suggestion=$(echo "$RESPONSE" | jq -r .suggestion)" >> $GITHUB_OUTPUT

      - name: Comment PR with bot suggestion
        if: ${{ github.event.workflow_run.pull_requests }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(jq -r '.[0].number' <<< '${{ toJson(github.event.workflow_run.pull_requests) }}')

          gh pr comment "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --body "ðŸ¤– **AI CI Bot Analysis**
          ${{ steps.bot.outputs.suggestion }}"
          
