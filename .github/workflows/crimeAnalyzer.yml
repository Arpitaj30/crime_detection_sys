name: Notify AI CI Bot

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  analyze-failure:
    name: Analyze CI Failure with AI Bot
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout the failed repository
      - name: Checkout target repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Download CI logs artifact
      - name: Download CI logs artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p logs
          gh run download ${{ github.event.workflow_run.id }} \
            --repo ${{ github.repository }} \
            --dir logs
          # Merge all .log files into one
          find logs -type f -name "*.log" -exec cat {} + > logs/ci_logs.txt || true

      # 3Ô∏è‚É£ Setup Python and jq
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # 4Ô∏è‚É£ Send logs to AI Bot and get suggestion & patch
      - name: Get bot suggestion from AI server
        id: bot
        env:
          CI_AGENT: ${{ secrets.CI_AGENT }}
          INSTALLATION_ID: ${{ secrets.INSTALLATION_ID }}
        run: |
          set -e

          if [ -z "$CI_AGENT" ]; then
            echo "‚ùå CI_AGENT is not set"
            exit 1
          fi

          echo "Preparing logs..."
          LOGS_JSON=$(tail -n 200 logs/ci_logs.txt | jq -Rs .)

          echo "Sending logs to AI Bot server..."
          RESPONSE=$(curl --fail --show-error -s \
            -X POST "$CI_AGENT/analyze" \
            -H "Content-Type: application/json" \
            -d "{
              \"repo\": \"${{ github.repository }}\",
              \"run_id\": \"${{ github.event.workflow_run.id }}\",
              \"installation_id\": \"$INSTALLATION_ID\",
              \"logs\": $LOGS_JSON
            }"
          )

          echo "LLM Response:"
          echo "$RESPONSE" | jq

          # 1Ô∏è‚É£ Extract the JSON block inside triple backticks
          SUGGESTION_JSON=$(echo "$RESPONSE" | \
            grep -oP '(?s)```json\n(.*?)\n```' | \
            sed 's/```json//g' | sed 's/```//g')
          
          # 2Ô∏è‚É£ Parse patch safely from JSON
          PATCH=$(echo "$SUGGESTION_JSON" | jq -r '.patch? // empty')
          
          # 3Ô∏è‚É£ Extract readable suggestion text (remove triple backticks, preserve explanation)
          SUGGESTION_TEXT=$(echo "$RESPONSE" | sed 's/```json//g' | sed 's/```//g')

          # Write suggestion text
          echo "suggestion<<EOF" >> $GITHUB_OUTPUT
          echo "$SUGGESTION_TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Write patch JSON
          echo "patch<<EOF" >> $GITHUB_OUTPUT
          echo "$PATCH" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT


      - name: Comment PR with AI Bot suggestion
        if: ${{ github.event.workflow_run.pull_requests }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # üëà THIS is required
        run: |
          PR_NUMBER=$(jq -r '.[0].number' <<< '${{ toJson(github.event.workflow_run.pull_requests) }}')

          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "No PR found, skipping comment."
            exit 0
          fi
          echo "Commenting on PR #$PR_NUMBER..."
          
          COMMENT_BODY=$(cat << EOF
          ü§ñ **AI CI Bot Analysis**
          
          **Suggestion:**
          ${{ steps.bot.outputs.suggestion }}
          
          **Patch (if available):**
          \`\`\`json
          ${{ steps.bot.outputs.patch }}
          \`\`\`
          EOF
              )
          
              gh pr comment "$PR_NUMBER" \
                --repo "${{ github.repository }}" \
                --body "$COMMENT_BODY"

          
      # 5Ô∏è‚É£ Comment PR with bot suggestion and patch
      # - name: Comment PR with AI Bot suggestion
      #   if: ${{ github.event.workflow_run.pull_requests }}
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     PR_NUMBER=$(jq -r '.[0].number' <<< '${{ toJson(github.event.workflow_run.pull_requests) }}')

      #     if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
      #       echo "No PR found, skipping comment."
      #       exit 0
      #     fi

      #     echo "Commenting on PR #$PR_NUMBER..."
          
      #     COMMENT_BODY=$(cat << EOF
      #     ü§ñ **AI CI Bot Analysis**
          
      #     **Suggestion:**
      #     ${{ steps.bot.outputs.suggestion }}
          
      #     **Patch (if available):**
      #     \`\`\`json
      #     ${{ steps.bot.outputs.patch }}
      #     \`\`\`
      #     EOF
      #               )
          
      #               gh pr comment "$PR_NUMBER" \
      #                 --repo "${{ github.repository }}" \
      #                 --body "$COMMENT_BODY"
          
      #               echo "‚úÖ PR commented with AI suggestion."














# name: Notify AI CI Bot

# on:
#   workflow_run:
#     workflows: ["CI"]
#     types:
#       - completed

# jobs:
#   analyze-failure:
#     name: Analyze CI Failure with AI Bot
#     if: ${{ github.event.workflow_run.conclusion == 'failure' }}
#     runs-on: ubuntu-latest

#     steps:
#       # -------------------------------------------------
#       #  Checkout the failed repository (crime_detection_sys)
#       # -------------------------------------------------
#       - name: Checkout target repository
#         uses: actions/checkout@v4

#       # -------------------------------------------------
#       #  Download CI logs from failed workflow
#       # -------------------------------------------------
#       - name: Download CI logs artifact
#         env:
#           GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#         run: |
#           mkdir -p logs

#           gh run download ${{ github.event.workflow_run.id }} \
#             --repo ${{ github.repository }} \
#             --dir logs

#           # Merge all .log files into one
#           find logs -type f -name "*.log" -exec cat {} + > logs/ci_logs.txt || true

#       # -------------------------------------------------
#       #  Setup Python
#       # -------------------------------------------------
#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.10"

#       - name: Install jq
#         run: |
#           sudo apt-get update
#           sudo apt-get install -y jq

#       - name: Get bot suggestion from AI server
#         id: bot
#         env:
#           CI_AGENT: ${{ secrets.CI_AGENT }}
#         run: |
#           set -e

#           echo "CI_AGENT=$CI_AGENT"

#           if [ -z "$CI_AGENT" ]; then
#             echo "‚ùå CI_AGENT is not set"
#             exit 1
#           fi
#           echo "Preparing logs..."
#           LOGS_JSON=$(tail -n 200 logs/ci_logs.txt | jq -Rs .)
      
#           echo "Sending logs to AI Bot server..."

#           RESPONSE=$(curl --fail --show-error -s \
#             -X POST "$CI_AGENT/analyze" \
#             -H "Content-Type: application/json" \
#             -d "{
#               \"repo\": \"${{ github.repository }}\",
#               \"run_id\": \"${{ github.event.workflow_run.id }}\",
#               \"installation_id\": \"${{ secrets.INSTALLATION_ID }}\",
#               \"logs\": $LOGS_JSON
#             }"
#           )

          
#           echo "LLM Response:"
#           echo "$RESPONSE" | jq
          
#           SUGGESTION=$(echo "$RESPONSE" | jq -r '.suggestion' | sed 's/```//g' | tr '\n' '\\n')

#           echo "suggestion<<EOF" >> $GITHUB_OUTPUT
#           echo "$SUGGESTION" >> $GITHUB_OUTPUT
#           echo "EOF" >> $GITHUB_OUTPUT


      # - name: Send CI logs to AI Bot
      #   id: send
      #   run: |
      #     CI_AGENT="${{ secrets.CI_AGENT }}"
      #     INSTALLATION_ID="${{ steps.get_installation.outputs.installation_id }}"
      #     LOGS_JSON=$(jq -Rs . < logs/ci_logs.txt)

      #     echo "Sending logs to AI Bot server..."
          
      #     RESPONSE=$(curl -s -X POST "$CI_AGENT/analyze" \
      #       -H "Content-Type: application/json" \
      #       -d @- << EOF
      #     {
      #       "repo": "${{ github.repository }}",
      #       "run_id": "${{ github.run_id }}",
      #       "installation_id": "$INSTALLATION_ID",
      #       "logs": $LOGS_JSON
      #     }
      #     EOF
      #     )

      #     echo "LLM Response:"
      #     echo "$RESPONSE" | jq

      #     # Save suggestion safely to GitHub Actions output
      #     echo "suggestion<<EOF" >> $GITHUB_OUTPUT
      #     echo "$RESPONSE" | jq -r .suggestion >> $GITHUB_OUTPUT
      #     echo "EOF" >> $GITHUB_OUTPUT

          
      # - name: Get bot suggestion from AI server
      #   id: bot
      #   env:
      #     CI_AGENT: ${{ secrets.CI_AGENT }}
      #   run: |
      #     echo "Sending logs to AI Bot server..."
          
      #     LOGS_JSON=$(tail -n 200 logs/ci_logs.txt | jq -Rs .)
          
      #     RESPONSE=$(curl -s -X POST "$CI_AGENT/analyze" \
      #       -H "Content-Type: application/json" \
      #       -d @- << EOF
      #     {
      #       "repo": "${{ github.repository }}",
      #       "run_id": "${{ github.event.workflow_run.id }}",
      #       "installation_id": "${{ secrets.INSTALLATION_ID }}",
      #       "logs": "$(sed 's/"/\\"/g' logs/ci_logs.txt)"
      #     }
      #     EOF
      #     )

      #     echo "LLM Response:"
      #     echo "$RESPONSE" | jq
          
      #     # Save suggestion safely to GitHub Actions output
      #     echo "suggestion<<EOF" >> $GITHUB_OUTPUT
      #     echo "$RESPONSE" | jq -r .suggestion >> $GITHUB_OUTPUT
      #     echo "EOF" >> $GITHUB_OUTPUT


      # - name: Comment PR with bot suggestion
      #   if: ${{ github.event.workflow_run.pull_requests }}
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     PR_NUMBER=$(jq -r '.[0].number' <<< '${{ toJson(github.event.workflow_run.pull_requests) }}')

      #     gh pr comment "$PR_NUMBER" \
      #       --repo "${{ github.repository }}" \
      #       --body "$(cat << 'EOF'
      #       ü§ñ **AI CI Bot Analysis**

      #       ${{ steps.bot.outputs.suggestion }}
      #       EOF
      #       )"
